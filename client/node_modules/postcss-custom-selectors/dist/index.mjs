import e from"postcss-selector-parser";import s from"fs";import t from"path";import o from"postcss";var n=s=>{let t;return e((e=>{t=e})).processSync(s),t},c=(e,s)=>{const t={};return e.nodes.slice().forEach((e=>{if(i(e)){const[,o,c]=e.params.match(a);t[o]=n(c),Object(s).preserve||e.remove()}})),t};const r=/^custom-selector$/i,a=/^(:--[A-z][\w-]*)\s+([\W\w]+)\s*$/,i=e=>"atrule"===e.type&&r.test(e.name)&&a.test(e.params);function u(e,s){let t=e.nodes.length-1;for(;t>=0;){const o=l(e.nodes[t],s);o.length&&e.nodes.splice(t,1,...o),--t}return e}function l(e,s){const t=[];for(const o in e.nodes){const{value:n,nodes:c}=e.nodes[o];if(n in s){for(const c of s[n].nodes){const n=e.clone(),r=c.clone().nodes;n.nodes.splice(o,1,...r.map(((s,t)=>("selector"===s.type&&(s.spaces={...e.nodes[t].spaces}),0===t&&s.spaces&&(s.spaces.before=""),t===r.length-1&&s.spaces&&(s.spaces.after=""),s))));const a=l(n,s);j(n.nodes,Number(o)),a.length?t.push(...a):t.push(n)}return t}c&&c.length&&u(e.nodes[o],s)}return t}const p=/^(tag|universal)$/,f=/^(class|id|pseudo|tag|universal)$/,m=e=>f.test(Object(e).type),j=(e,s)=>{if(s&&(t=e[s],p.test(Object(t).type))&&m(e[s-1])){let t=s-1;for(;t&&m(e[t]);)--t;if(t<s){const o=e.splice(s,1)[0];e.splice(t,0,o),e[t].spaces.before=e[t+1].spaces.before,e[t+1].spaces.before="",e[s]&&(e[s].spaces.after=e[t].spaces.after,e[t].spaces.after="")}}var t};function b(e){return c(e)}function w(e){const s=Object.assign({},Object(e).customSelectors||Object(e)["custom-selectors"]);for(const e in s)s[e]=n(s[e]);return s}function y(e){return e.map((e=>{if(e instanceof Promise)return e;if(e instanceof Function)return e();const s=e===Object(e)?e:{from:String(e)};if(Object(s).customSelectors||Object(s)["custom-selectors"])return s;const o=String(s.from||"");return{type:(s.type||t.extname(o).slice(1)).toLowerCase(),from:o}})).reduce((async(e,s)=>{const n=await e,{type:c,from:r}=await s;return"ast"===c?Object.assign(n,b(r)):"css"===c?Object.assign(n,await async function(e){const s=await O(t.resolve(e));return b(o.parse(s,{from:t.resolve(e)}))}(r)):"js"===c?Object.assign(n,await async function(e){return w(await import(t.resolve(e)))}(r)):"json"===c?Object.assign(n,await async function(e){return w(await g(t.resolve(e)))}(r)):Object.assign(n,w(await s))}),Promise.resolve({}))}const O=e=>new Promise(((t,o)=>{s.readFile(e,"utf8",((e,s)=>{e?o(e):t(s)}))})),g=async e=>JSON.parse(await O(e));function d(e,s){return Promise.all(s.map((async s=>{if(s instanceof Function)await s(S(e));else{const o=s===Object(s)?s:{to:String(s)},n=o.toJSON||S;if("customSelectors"in o)o.customSelectors=n(e);else if("custom-selectors"in o)o["custom-selectors"]=n(e);else{const s=String(o.to||""),c=(o.type||t.extname(o.to).slice(1)).toLowerCase(),r=n(e);"css"===c&&await async function(e,s){const t=`${Object.keys(s).reduce(((e,t)=>(e.push(`@custom-selector ${t} ${s[t]};`),e)),[]).join("\n")}\n`;await v(e,t)}(s,r),"js"===c&&await async function(e,s){const t=`module.exports = {\n\tcustomSelectors: {\n${Object.keys(s).reduce(((e,t)=>(e.push(`\t\t'${$(t)}': '${$(s[t])}'`),e)),[]).join(",\n")}\n\t}\n};\n`;await v(e,t)}(s,r),"json"===c&&await async function(e,s){const t=`${JSON.stringify({"custom-selectors":s},null,"\t")}\n`;await v(e,t)}(s,r),"mjs"===c&&await async function(e,s){const t=`export const customSelectors = {\n${Object.keys(s).reduce(((e,t)=>(e.push(`\t'${$(t)}': '${$(s[t])}'`),e)),[]).join(",\n")}\n};\n`;await v(e,t)}(s,r)}}})))}const S=e=>Object.keys(e).reduce(((s,t)=>(s[t]=String(e[t]),s)),{}),v=(e,t)=>new Promise(((o,n)=>{s.writeFile(e,t,(e=>{e?n(e):o()}))})),$=e=>e.replace(/\\([\s\S])|(')/g,"\\$1$2").replace(/\n/g,"\\n").replace(/\r/g,"\\r"),h=s=>{const t=Boolean(Object(s).preserve),o=[].concat(Object(s).importFrom||[]),n=[].concat(Object(s).exportTo||[]),r=y(o),a=Symbol("customSelectorHelper");return{postcssPlugin:"postcss-custom-selectors",Once:async(e,s)=>{s[a]=Object.assign(await r,c(e,{preserve:t})),await d(s[a],n)},Rule:(s,o)=>{s.selector.match(/:--[A-z][\w-]*/)&&((s,t,o)=>{const n=e((e=>{u(e,t)})).processSync(s.selector);n!==s.selector&&(s.cloneBefore({selector:n}),o.preserve||s.remove())})(s,o[a],{preserve:t})}}};h.postcss=!0;export{h as default};
