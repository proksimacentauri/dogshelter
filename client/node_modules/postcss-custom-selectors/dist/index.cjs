"use strict";var e=require("postcss-selector-parser"),t=require("fs"),s=require("path"),n=require("postcss");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var n=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var r=c(e),a=c(t),i=c(s),u=c(n),l=e=>{let t;return r.default((e=>{t=e})).processSync(e),t},f=(e,t)=>{const s={};return e.nodes.slice().forEach((e=>{if(d(e)){const[,n,c]=e.params.match(m);s[n]=l(c),Object(t).preserve||e.remove()}})),s};const p=/^custom-selector$/i,m=/^(:--[A-z][\w-]*)\s+([\W\w]+)\s*$/,d=e=>"atrule"===e.type&&p.test(e.name)&&m.test(e.params);function j(e,t){let s=e.nodes.length-1;for(;s>=0;){const n=b(e.nodes[s],t);n.length&&e.nodes.splice(s,1,...n),--s}return e}function b(e,t){const s=[];for(const n in e.nodes){const{value:c,nodes:o}=e.nodes[n];if(c in t){for(const o of t[c].nodes){const c=e.clone(),r=o.clone().nodes;c.nodes.splice(n,1,...r.map(((t,s)=>("selector"===t.type&&(t.spaces={...e.nodes[s].spaces}),0===s&&t.spaces&&(t.spaces.before=""),s===r.length-1&&t.spaces&&(t.spaces.after=""),t))));const a=b(c,t);g(c.nodes,Number(n)),a.length?s.push(...a):s.push(c)}return s}o&&o.length&&j(e.nodes[n],t)}return s}const O=/^(tag|universal)$/,y=/^(class|id|pseudo|tag|universal)$/,w=e=>y.test(Object(e).type),g=(e,t)=>{if(t&&(s=e[t],O.test(Object(s).type))&&w(e[t-1])){let s=t-1;for(;s&&w(e[s]);)--s;if(s<t){const n=e.splice(t,1)[0];e.splice(s,0,n),e[s].spaces.before=e[s+1].spaces.before,e[s+1].spaces.before="",e[t]&&(e[t].spaces.after=e[s].spaces.after,e[s].spaces.after="")}}var s};function v(e){return f(e)}function S(e){const t=Object.assign({},Object(e).customSelectors||Object(e)["custom-selectors"]);for(const e in t)t[e]=l(t[e]);return t}function h(e){return e.map((e=>{if(e instanceof Promise)return e;if(e instanceof Function)return e();const t=e===Object(e)?e:{from:String(e)};if(Object(t).customSelectors||Object(t)["custom-selectors"])return t;const s=String(t.from||"");return{type:(t.type||i.default.extname(s).slice(1)).toLowerCase(),from:s}})).reduce((async(e,t)=>{const s=await e,{type:n,from:c}=await t;return"ast"===n?Object.assign(s,v(c)):"css"===n?Object.assign(s,await async function(e){const t=await $(i.default.resolve(e));return v(u.default.parse(t,{from:i.default.resolve(e)}))}(c)):"js"===n?Object.assign(s,await async function(e){var t;return S(await(t=i.default.resolve(e),Promise.resolve().then((function(){return o(require(t))}))))}(c)):"json"===n?Object.assign(s,await async function(e){return S(await P(i.default.resolve(e)))}(c)):Object.assign(s,S(await t))}),Promise.resolve({}))}const $=e=>new Promise(((t,s)=>{a.default.readFile(e,"utf8",((e,n)=>{e?s(e):t(n)}))})),P=async e=>JSON.parse(await $(e));function x(e,t){return Promise.all(t.map((async t=>{if(t instanceof Function)await t(k(e));else{const s=t===Object(t)?t:{to:String(t)},n=s.toJSON||k;if("customSelectors"in s)s.customSelectors=n(e);else if("custom-selectors"in s)s["custom-selectors"]=n(e);else{const t=String(s.to||""),c=(s.type||i.default.extname(s.to).slice(1)).toLowerCase(),o=n(e);"css"===c&&await async function(e,t){const s=`${Object.keys(t).reduce(((e,s)=>(e.push(`@custom-selector ${s} ${t[s]};`),e)),[]).join("\n")}\n`;await q(e,s)}(t,o),"js"===c&&await async function(e,t){const s=`module.exports = {\n\tcustomSelectors: {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t\t'${F(s)}': '${F(t[s])}'`),e)),[]).join(",\n")}\n\t}\n};\n`;await q(e,s)}(t,o),"json"===c&&await async function(e,t){const s=`${JSON.stringify({"custom-selectors":t},null,"\t")}\n`;await q(e,s)}(t,o),"mjs"===c&&await async function(e,t){const s=`export const customSelectors = {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t'${F(s)}': '${F(t[s])}'`),e)),[]).join(",\n")}\n};\n`;await q(e,s)}(t,o)}}})))}const k=e=>Object.keys(e).reduce(((t,s)=>(t[s]=String(e[s]),t)),{}),q=(e,t)=>new Promise(((s,n)=>{a.default.writeFile(e,t,(e=>{e?n(e):s()}))})),F=e=>e.replace(/\\([\s\S])|(')/g,"\\$1$2").replace(/\n/g,"\\n").replace(/\r/g,"\\r"),N=e=>{const t=Boolean(Object(e).preserve),s=[].concat(Object(e).importFrom||[]),n=[].concat(Object(e).exportTo||[]),c=h(s),o=Symbol("customSelectorHelper");return{postcssPlugin:"postcss-custom-selectors",Once:async(e,s)=>{s[o]=Object.assign(await c,f(e,{preserve:t})),await x(s[o],n)},Rule:(e,s)=>{e.selector.match(/:--[A-z][\w-]*/)&&((e,t,s)=>{const n=r.default((e=>{j(e,t)})).processSync(e.selector);n!==e.selector&&(e.cloneBefore({selector:n}),s.preserve||e.remove())})(e,s[o],{preserve:t})}}};N.postcss=!0,module.exports=N;
